if(!FPhi)var FPhi={};function arrayBufferToBase64(e){for(var t="",i=new Uint8Array(e),s=i.byteLength,a=0;a<s;a++)t+=String.fromCharCode(i[a]);return window.btoa(t)}if(FPhi.Selphi||(FPhi.Selphi={}),FPhi.Selphi.Mode={Register:0,Authenticate:1},FPhi.Selphi.LivenessMode={None:0,Blink:1,Move:2,Passive:3},FPhi.Selphi.ExceptionType={CameraError:0,ExtractorError:1,ControlNotInitializedError:2,ImageCropResizeError:3,UnexpectedCaptureError:4},FPhi.Selphi.TemplateFormat={ByteArray:0,Base64:1},FPhi.Selphi.ImageFormat={None:0,Gray_8bpp:1,RGB_24bpp:2,BGR_24bpp:3,ARGB_32bpp:4,YUV_NV21:5,ABGR_32bpp:6,BGRA_32bpp:7,RGBA_32bpp:8},FPhi.Selphi.SampleDiagnostic={Ok:0,FaceNotFound:1,RightEyeNotFound:2,LeftEyeNotFound:3,EyesNotFound:4,FaceTooFar:5,FaceTooClose:6,TooCloseToWindowSide:7,AngleExceeded:8,QualityCheckFailed:9,NotRated:10},FPhi.Selphi.FinalDiagnostic={InsufficientValidSamples:0,TemplateCreationInProgress:1,TemplateCreated:2},FPhi.Selphi.LivenessDiagnostic={NotRated:0,PhotoDetected:1,LivenessDetected:2,Unsuccess:3,UnsuccessLowPerformance:4,UnsuccessGlasses:5,UnsuccessLight:6,UnsuccessNoMovement:7,UnsuccessWrongDirection:8,UnsuccessTooFar:9},FPhi.Selphi.RecorderType={Gif:0,Remote:1},FPhi.Selphi.CameraType={Front:0,Back:1},FPhi.Selphi.TrackStatus={ChangeState:0,Tap:1},FPhi.Selphi.Widget=function(e){if(this.version="5.5.3.24",console.log("FPhi.Selphi.Widget version: "+this.version),this.filePostExt=this.version,""==this.version&&(this.filePostExt=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)),this.cm=e,this.divContainer=e.getContainer(),this.mode=e.getMode(),this.livenessMode=e.getLivenessMode(),this.tutorial=e.getTutorial(),this.stabilizationStage=e.getStabilizationStage(),this.onExtractionFinish=e.getOnExtractionFinish(),this.onUserCancel=e.getOnUserCancel(),this.onExceptionCaptured=e.getOnExceptionCaptured(),this.onExtractionTimeout=e.getOnExtractionTimeout(),this.onModuleLoaded=e.getOnModuleLoaded(),this.onLivenessError=e.getOnLivenessError(),this.onLivenessErrorButtonClick=e.getOnLivenessErrorButtonClick(),this.onTimeoutErrorButtonClick=e.getOnTimeoutErrorButtonClick(),this.onStabilizing=e.getOnStabilizing(),this.onTrackStatus=e.getOnTrackStatus(),this.livenessMoveTimer=new FPhi.Timer,this.livenessPrecision=e.getLivenessPrecision(),this.livenessMoveInitialError=e.getLivenessMoveInitialError(),this.livenessMoveInfoTime=e.getLivenessMoveInfoTime(),this.interactible=e.getInteractible(),this.registerTime=e.getRegisterTime(),this.authenticateTime=e.getAuthenticateTime(),this.graphPath=e.getGraphPath(),this.imageFormat=e.getImageFormat(),this.imageQuality=e.getImageQuality(),this.logImages=e.getLogImages(),this.cropFactor=e.getCropFactor(),this.cropImage=e.getCropImage(),this.cameraReady=!1,this.path=this.getScriptPath("FPhi.Widget.wasm.js"),console.log("FPhi.Selphi.Widget: Serving from URL: "+this.path),console.log("FPhi.Selphi.Widget: wasm path: "+this.path+"FPhiExtractor.wasm"),this.wasmReady=!1,this.wasmInitiated=!1,this.worker=new Worker(this.path+"FPhi.Widget.worker.wasm.js?"+this.filePostExt),this.worker.onmessage=this.handleExtractorMessage.bind(this),this.worker.widget=this,this.queuedCommands=0,this.resourceParent=null,this.language=e.getLanguage(),this.cameraWidth=e.getCameraWidth(),this.cameraHeight=e.getCameraHeight(),this.cameraType=e.getCameraType(),this.cameraRotation=e.getCameraRotation(),this.canvasWidth=500,this.canvasHeight=500,this.fontSizeFactor=this.canvasHeight/500,this.canvasSizeFactor=this.canvasHeight/500,this.fpsTime=performance.now(),this.baseURL=e.getResourcesPath(),this.dpiList=e.getDpiList(),this.mode==FPhi.Selphi.Mode.Authenticate&&(this.livenessMode==FPhi.Selphi.LivenessMode.Passive?(this.livenessMode=FPhi.Selphi.LivenessMode.None,this.cameraWidth=1280,this.cameraHeight=720,this.cropImage=!1):this.livenessMode==FPhi.Selphi.LivenessMode.Move&&(this.cameraWidth=640,this.cameraHeight=480)),null!=document.getElementById("FPhi_Widget_rm_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_rm_script")),this.rmScript=document.createElement("script"),this.rmScript.id="FPhi_Widget_rm_script",this.rmReady=!1,this.rmScript.type="text/javascript",this.rmScript.src=this.path+"FPhi.Widget.rm.wasm.js?"+this.filePostExt,this.rmScript.onreadystatechange=this.OnResourceManagerLoaded.bind(this),this.rmScript.onload=this.OnResourceManagerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.rmScript),null!=document.getElementById("FPhi_Widget_graph_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_graph_script")),this.graphScript=document.createElement("script"),this.graphScript.id="FPhi_Widget_graph_script",this.graphReady=!1,this.graphScript.type="text/javascript",this.graphScript.src=this.path+"FPhi.Widget.graph.wasm.js?"+this.filePostExt,this.graphScript.onreadystatechange=this.OnGraphLoaded.bind(this),this.graphScript.onload=this.OnGraphLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.graphScript),null!=document.getElementById("FPhi_Widget_drawer_script")&&document.head.removeChild(document.getElementById("FPhi_Widget_drawer_script")),this.drawerScript=document.createElement("script"),this.drawerScript.id="FPhi_Widget_drawer_script",this.drawerScript.type="text/javascript",this.drawerScript.src=this.path+"FPhi.Widget.drawer.wasm.js?"+this.filePostExt,this.drawerScript.onload=this.OnDrawerLoaded.bind(this),document.getElementsByTagName("head")[0].appendChild(this.drawerScript),this.divContainer.addEventListener("FPhi.UserControl.Finish.event",this.onExtractionFinish,!0),this.divContainer.addEventListener("FPhi.UserControl.UserCancel.event",this.onUserCancel,!0),this.divContainer.addEventListener("FPhi.UserControl.ExtractionTimeout.event",this.onExtractionTimeout,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessError.event",this.onLivenessError,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessErrorButtonClick.event",this.onLivenessErrorButtonClick,!0),this.divContainer.addEventListener("FPhi.UserControl.TimeoutErrorButtonClick.event",this.onTimeoutErrorButtonClick,!0),this.divContainer.addEventListener("FPhi.UserControl.ModuleLoaded.event",this.onModuleLoaded,!0),this.divContainer.addEventListener("FPhi.UserControl.ExceptionCaptured.event",this.onExceptionCaptured,!0),this.divContainer.addEventListener("FPhi.UserControl.Stabilizing.event",this.onStabilizing,!0),this.divContainer.addEventListener("FPhi.UserControl.TrackStatus.event",this.onTrackStatus,!0),this.cameraContainer=document.createElement("div"),this.cameraContainer.id="cameraContainer",this.cameraContainer.style.overflow="hidden",this.cameraContainer.style.position="relative",this.cameraContainer.style.width=this.divContainer.offsetWidth+"px",this.cameraContainer.style.height=this.divContainer.offsetHeight+"px",this.divContainer.appendChild(this.cameraContainer),this.gifWait=document.createElement("img"),this.gifWait.style.display="none",this.gifWaitOnLoadContext=this.onWaitingLoaded.bind(this),this.gifWait.addEventListener("load",this.gifWaitOnLoadContext),this.gifWait.src=this.path+"FPhi.Widget.Resources/resources/163dpi/2_loading_selphi.gif",this.cropFactor<=0){var t=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Invalid value of CropFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(t),this.cropFactor=1}this.sceneTimeout<=0&&(this.sceneTimeout=0)},FPhi.Selphi.Widget.prototype={constructor:FPhi.Selphi.Widget,language:"es",userTags:null,privateCanvas:null,extractor:null,extractorLiveness:null,extractorVersion:"",livenessTimer:null,lastDetectResult:null,lastExtractionResult:null,lastExtractionResultWizard:null,faceAvailable:!0,faceDataRect:null,faceAvailableDelayed:!0,faceTooFar:!1,bestScore:0,actualTime:0,actualTimePrev:0,clockWaitingFace:null,clockWaitingStart:null,clockExtraction:null,clockExtractionPure:null,clockCycleTip:null,clockWizardCompleted:null,clockShowResults:null,clockImprove:null,clockLiveness1:null,clockLiveness2:null,clockLiveness3:null,clockLiveness3_finish:null,clockFinish:null,clockNewScenario:null,clockWarningIn:null,clockWarningOut:null,clockEyeDetection:null,clockEyeDetectionDetected:null,waitingTimeStart:3,extractionTime:5,extractionTimePartial:0,extractionSmartMinScore:.5,liveness1Time:.5,liveness3Time:.25,livenessActualRetrain:0,livenessCalculating:!1,livenessErrorString:"",livenessErrorImage:null,livenessMoveDirection:-1,livenessMoveActualSuccessfulAttempts:0,livenessMoveActualFailedAttempts:0,livenessMoveNextIndex:0,livenessMoveGlassesFail:0,livenessMoveInit:!1,livenessMoveFailReason:0,livenessMoveInfoTime:3,livenessMoveLastStabilizedStatus:0,livenessMoveStabilizedStatusHistory:[],livenessMoveHistory:[],livenessPrecision:0,showImproveButton:!1,maxResults:15,graphicalScoreMax:0,privateLastImage:null,privateImages:[],logImages:!1,privateLivenessImages:[],privateLivenessImageTemp:null,privateLivenessTimerDiagnostic:null,privateLivenessResults:[],privateEyesYLevel:0,idContainer:null,divContainer:null,extractorContainer:null,videoSelectId:null,cameraContainer:null,cameraWidth:null,cameraHeight:null,cameraRotation:0,canvasWidth:null,canvasHeight:null,cameraStream:null,selectedSource:null,samplePeriod:0,buttonHeight:50,debug:!1,interactible:!0,imageFormat:"image/jpeg",forceMoveDirection:-1,registerTime:7,authenticateTime:1,globalTimeout:30,fps:0,fpse:0,fpsframes:0,fpseFrames:0,fpsTime:null,fontSizeFactor:1,canvasSizeFactor:1,imageTips1:null,imageTips2:null,imageFaceMoving:[],imageCheck:null,imageError:null,imageArrow:null,imageCamera:null,cropImage:!0,cropFactor:1,warningInTime:.8,warningOutTime:0,detectionTimeout:3e4,extractionTimeout:3e4,sceneTimeout:0,secondsWidget:0,secondsState:0,sendingTimeout:2,cameraList:new Array,graphPath:"graph.xml",Start:function(){document.featurePolicy&&0==document.featurePolicy.allowsFeature("camera")&&(console.log("Selphi: Feature Policy issue: Camera feature is restricted in the actual environment. Check your server HTTP Headers."),console.log("https://developers.google.com/web/updates/2018/06/feature-policy#js")),window.location!==window.parent.location&&console.log("Selphi widget running inside iframe."),this.selectedSource=null;var e=document.createElement("canvas");e.id="display",e.style="position:absolute; top:0px; left:0px; zIndex:1;",this.cameraContainer.appendChild(e),e.width=this.cameraContainer.offsetWidth,e.height=this.cameraContainer.offsetHeight,this.canvas=e,this.onCanvasResizeContext=this.onCanvasResize.bind(this),window.addEventListener("resize",this.onCanvasResizeContext,!1),this.initCamera(this.cameraContainer,this.cameraWidth,this.cameraHeight),this.setVideoInput(this),this.widgetTime=performance.now(),this.stateTime=this.widgetTime,this.cameraContainer.appendChild(this.gifWait),this.debug&&console.log("Hardware concurrency: "+window.navigator.hardwareConcurrency)},Stop:function(){if(null!=this.worker&&(this.postMessage(this,{cmd:"destroy"}),this.worker.widget=null,this.worker=null),null!=this.divContainer){this.onCanvasResizeContext&&(window.removeEventListener("resize",this.onCanvasResizeContext,!1),this.onCanvasResizeContext=void 0),this.divContainer.removeEventListener("FPhi.UserControl.Finish.event",this.onExtractionFinish,!0),this.divContainer.removeEventListener("FPhi.UserControl.UserCancel.event",this.onUserCancel,!0),this.divContainer.removeEventListener("FPhi.UserControl.ExtractionTimeout.event",this.onExtractionTimeout,!0),this.divContainer.removeEventListener("FPhi.UserControl.LivenessError.event",this.onLivenessError,!0),this.divContainer.removeEventListener("FPhi.UserControl.LivenessErrorButtonClick.event",this.onLivenessErrorButtonClick,!0),this.divContainer.removeEventListener("FPhi.UserControl.TimeoutErrorButtonClick.event",this.onTimeoutErrorButtonClick,!0),this.divContainer.removeEventListener("FPhi.UserControl.ModuleLoaded.event",this.onModuleLoaded,!0),this.divContainer.removeEventListener("FPhi.UserControl.ExceptionCaptured.event",this.onExceptionCaptured,!0),this.divContainer.removeEventListener("FPhi.UserControl.Stabilizing.event",this.onStabilizing,!0),this.divContainer.removeEventListener("FPhi.UserControl.TrackStatus.event",this.onTrackStatus,!0),this.video.onloadedmetadata=null;var e=this.canvas;e.onmousemove=null,e.onclick=null,this.divContainer.removeChild(this.cameraContainer),this.divContainer=null,this.cameraContainer=null}null!=this.cameraStream&&this.cameraStream.getVideoTracks()[0].stop(),null!=this.rm&&(this.rm.caller=null,this.rm=null),null!=this.graph&&(this.graph=null),null!=this.drawer&&(this.drawer=null),null!=this.rmScript&&(this.rmScript.onreadystatechange=null,this.rmScript.onload=null,this.rmScript=null),null!=this.graphScript&&(this.graphScript.onreadystatechange=null,this.graphScript.onload=null,this.graphScript=null),null!=this.drawerScript&&(this.drawerScript.onload=null,this.drawerScript=null)},reconfigureWidget:function(e){this.imageFormat=e.getImageFormat(),this.imageQuality=e.getImageQuality(),this.cropFactor=e.getCropFactor(),this.cropImage=e.getCropImage(),console.log("FPhi.Selphi.Widget.reconfigureWidget fired"),console.log("  imageFormat: "+this.imageFormat),console.log("  imageQuality: "+this.imageQuality),console.log("  cropFactor: "+this.cropFactor),console.log("  cropImage: "+this.cropImage)},onWaitingLoaded:function(){var e=this.canvas.height/2-this.gifWait.height/2,t=this.canvas.width/2-this.gifWait.width/2;this.gifWait.style="position:absolute; top:"+e+"px; left:"+t+"px;"},onCanvasResize:function(){var e=this.canvas,t=e.getContext("2d",{alpha:!0}),i=this.video;if(this.cameraWidth=i.videoWidth,this.cameraHeight=i.videoHeight,0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=this.cameraWidth,this.privateCanvas.height=this.cameraHeight):(this.privateCanvas.width=this.cameraHeight,this.privateCanvas.height=this.cameraWidth),this.cameraContainer.style.width=this.divContainer.offsetWidth+"px",this.cameraContainer.style.height=this.divContainer.offsetHeight+"px",e.width=this.cameraContainer.offsetWidth,e.height=this.cameraContainer.offsetHeight,this.drawer.setCanvasSize(e.clientWidth,e.clientHeight),null!=this.elements)for(var s=0;s<this.elements.length;s++)null!=this.elements[s].videoPlayer&&(this.elements[s].videoPlayer.pause(),this.elements[s].videoPlayer.removeAttribute("src"),this.elements[s].videoPlayer.removeEventListener("ended",this.videoplayerEnded.bind(self),!1),this.elements[s].videoPlayer.load(),this.elements[s].videoPlayer=null);this.elements=this.rm.getElements(this.resourceParent,this.drawer.landscape),this.startVideos(this),this.setCameraPosition(t,i)},GetAvailableCameras:function(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(this.gotDevices).catch(this.handleCameraError):(console.log("GetMediaDevices not available for this browser"),null)},postMessage:function(e,t){e.queuedCommands++,e.worker.postMessage(t)},setLastExtractionResult:function(e,t){null!=e.lastExtractionResult&&e.lastExtractionResult.delete(),e.lastExtractionResult=t},setCameraPosition:function(e,t){var i=this.drawer.getCameraRect(e,this.cameraWidth,this.cameraHeight,this.resourceParent),s="180deg";this.cameraType==FPhi.Selphi.CameraType.Back&&(s="0deg");var a="";1==this.cameraRotation?a="transform:rotateZ(90deg);":2==this.cameraRotation?a="transform:rotateZ(180deg);":3==this.cameraRotation&&(a="transform:rotateZ(270deg);"),i.visible?t.style="position:absolute; top:"+i.y+"px; left:"+i.x+"px; width:"+i.width+"px; height:"+i.height+"px; transform:rotateY("+s+"); zIndex:0;"+a:t.style="position:absolute; top:-10000px; left:0px; width:"+i.width+"px; height:"+i.height+"px; transform:rotateY("+s+"); zIndex:0;"+a},OnGraphNewState:function(e){this.stateTime=performance.now();var t=this.canvas;"UCNothing"!=this.state&&void 0!==this.state||(this.actualTime=this.stateTime,this.widgetTime=this.stateTime),this.secondsWidget=(this.actualTime-this.widgetTime)/1e3,this.secondsState=(this.actualTime-this.stateTime)/1e3,this.state=e,this.resourceParent=this.drawer.getResourceIdForState(e);var i=this.video;if(this.setCameraPosition(t.getContext("2d",{alpha:!0}),i),this.debug&&console.log("state: "+e),null!=this.elements)for(var s=0;s<this.elements.length;s++)null!=this.elements[s].videoPlayer&&(this.elements[s].videoPlayer.pause(),this.elements[s].videoPlayer.removeAttribute("src"),this.elements[s].videoPlayer.removeEventListener("ended",this.videoplayerEnded.bind(m),!1),this.elements[s].videoPlayer.load(),this.elements[s].videoPlayer=null);if(this.elements=null,null!=this.resourceParent&&(this.elements=this.rm.getElements(this.resourceParent,this.drawer.landscape),this.startVideos(this)),"UCNothing"==e)this.clockNewScenario=performance.now(),this.lastExtractionResult=null,this.bestScore=0,this.faceAvailable=!1,this.clockWaitingStart=null,this.clockExtraction=null,this.clockExtractionPure=null,this.clockLiveness=null,this.mode==FPhi.Selphi.Mode.Register?this.extractionTime=this.registerTime:this.livenessMode==FPhi.Selphi.LivenessMode.Move?this.extractionTime=0:this.extractionTime=this.authenticateTime,this.livenessCalculating=!1,this.privateLastImage=null,this.privateImages=[],this.privateLivenessImages=[],this.privateLivenessResults=[],this.livenessActualRetrain=0,this.livenessErrorString=null;else if("UCTutorialRegister2"==e)this.clockNewScenario=performance.now();else if("UCWaitingFaceStart"==e)this.clockNewScenario=performance.now(),this.mode==FPhi.Selphi.Mode.Authenticate&&this.livenessMode==FPhi.Selphi.LivenessMode.Blink&&(this.postMessage(this,{cmd:"livenessTimerSetValues",timeLapse:700,fps:10}),this.postMessage(this,{cmd:"livenessTimerReset"})),0==this.interactible&&this.graph.sendMessage("Click//button_start");else if("UCSelectTutorial"==e)this.graph.sendMessage("SetMode//"+this.mode+","+this.livenessMode);else if("UCExtracting"==e)this.clockNewScenario=performance.now(),this.clockExtraction=performance.now(),this.clockExtractionPure=this.clockExtraction,this.extractionTimePartial=0,this.postMessage(this,{cmd:"initStreamExtraction",mode:this.mode,livenessMode:this.livenessMode,userTags:this.userTags});else if("UCShowResults"==e)this.clockNewScenario=performance.now(),this.clockShowResults=performance.now(),null!=this.lastExtractionResultWizard&&(this.setLastExtractionResult(this.lastExtractionResultWizard),this.lastExtractionResultWizard=null);else if("UCCancelByUser"==e){this.clockNewScenario=performance.now();var a=new CustomEvent("FPhi.UserControl.UserCancel.event");this.divContainer.dispatchEvent(a),this.Stop()}else if("UCLivenessDetectionStep1"==e)this.clockNewScenario=performance.now(),this.clockLiveness1=performance.now();else if("UCLivenessDetectionStep2"==e)this.clockLiveness2=performance.now(),this.privateLivenessImages=[],this.privateLivenessResults=[],this.postMessage(this,{cmd:"livenessTimerReset"});else if("UCLivenessDetectionStep3"==e)this.clockLiveness3_finish=null,this.clockLiveness3=performance.now(),this.postMessage(this,{cmd:"evaluateLiveness",images:this.privateLivenessImages,template:this.lastExtractionResult.Template});else if("UCWaitingEyeDetection"==e)this.clockNewScenario=performance.now(),this.clockEyeDetection=performance.now(),this.clockEyeDetectionDetected=null;else if("UCFinish"==e){this.clockNewScenario=performance.now(),this.clockFinish=performance.now();var n=Array.from(this.privateImages);this.sortImagesByFacialScore(this,n);var r,o=this.getImgTag(n[0],!1,this.cropFactor,this.imageFormat,this.imageQuality),h=this.getImgTag(n[0],!0,this.cropFactor,this.imageFormat,this.imageQuality),l=[];if(this.logImages){console.log("Image Quality: "+this.imageQuality);for(s=0;s<this.privateImages.length;s++)void 0!=this.privateImages[s]&&l.push(this.getImgTag(this.privateImages[s],this.cropImage,this.cropFactor,"image/jpeg",this.imageQuality))}void 0!=this.lastExtractionResult.templateRaw&&(r=this.lastExtractionResult.templateRaw,this.cm.getTemplateFormat()==FPhi.Selphi.TemplateFormat.Base64&&(r=arrayBufferToBase64(r)));var c=this.lastExtractionResult.template;this.cm.getTemplateFormat()==FPhi.Selphi.TemplateFormat.Base64&&(c=arrayBufferToBase64(c));var d={template:c,bestImage:o,bestImageCropped:h,images:l,timeStamp:this.privateLivenessResults,templateRaw:r,livenessMoveFails:this.livenessMoveActualFailedAttempts,sunGlassesScore:this.lastExtractionResult.sunGlassesScore,livenessMoveHistory:this.livenessMoveHistory,livenessMoveStabilizedHistory:this.livenessMoveStabilizedStatusHistory,livenessMoveStabilizedStatus:this.livenessMoveLastStabilizedStatus};this.cm.getVideoRecord()&&(d.video=this.recordedVideo);a=new CustomEvent("FPhi.UserControl.Finish.event",{detail:d});this.divContainer.dispatchEvent(a),this.Stop()}else if("UCErrors"==e){d={livenessMoveFails:this.livenessMoveActualFailedAttempts,livenessMoveHistory:this.livenessMoveHistory,livenessMoveStabilizedHistory:this.livenessMoveStabilizedStatusHistory,livenessMoveStabilizedStatus:this.livenessMoveLastStabilizedStatus};if(null!=this.lastExtractionResult&&null!=this.lastExtractionResult.sunGlassesScore&&(d.sunGlassesScore=this.lastExtractionResult.sunGlassesScore),this.logImages){for(l=[],s=0;s<this.privateImages.length;s++)void 0!=this.privateImages[s]&&l.push(this.getImgTag(this.privateImages[s],this.cropImage,this.cropFactor,this.imageFormat,this.imageQuality));d.images=l,d.timeStamp=this.privateLivenessResults}if(this.clockNewScenario=performance.now(),this.livenessDiagnostic<0)this.divContainer.dispatchEvent(new CustomEvent("FPhi.UserControl.ExtractionTimeout.event",{detail:d}));else{d.livenessErrorType=this.livenessDiagnostic;a=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:d});this.divContainer.dispatchEvent(a)}}else if("UCLivenessMoveStabilizing"==e)this.livenessMoveTimer.SetValues(1750,12,0),this.postMessage(this,{cmd:"initLivenessMoveStabilization"});else if("UCLivenessMoveStabilized"==e)this.livenessMode==FPhi.Selphi.LivenessMode.Move?(this.livenessMoveTimer.Reset(),0==this.livenessMoveInit&&(this.postMessage(this,{cmd:"initLivenessMoveSequence",livenessPrecision:this.livenessPrecision}),this.livenessMoveInit=!0),this.postMessage(this,{cmd:"nextLivenessMoveSequence"}),this.livenessMoveNextIndex=0,this.graph.sendMessage("Move")):this.graph.sendMessage("NoMove");else if("UCLivenessMoveDetecting"==e)this.privateLivenessImages=[];else if("UCLivenessMoveProcessing"==e)this.processingIndexBase=this.livenessMoveNextIndex;else if("UCWaitRecording"==e&&this.cm.getVideoRecord()){console.log("generating movie"),this.agProcessing=!0;var m=this;this.agProcessingFirst=performance.now(),this.recorder.generateVideo().then(function(e){m.recorderFinish=!0,m.recordedVideo=e},function(e){})}if(null!=this.onTrackStatus&&this.divContainer){var v=new CustomEvent("FPhi.UserControl.TrackStatus.event",{detail:{code:FPhi.Selphi.TrackStatus.ChangeState,timeStamp:this.secondsWidget,data:e}});this.divContainer.dispatchEvent(v)}null!=this.graph&&this.graph.sendMessage("SetStatusFinished")},getImageData:function(e){var t=e.getContext("2d"),i=e.height,s=e.width;return{width:s,height:i,pixels:t.getImageData(0,0,s,i),time:performance.now()}},getImgTag:function(e,t,i,s,a){var n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").putImageData(e.pixels,0,0);var r=document.createElement("canvas");if(t&&void 0!=e.extractionResult&&void 0!=e.extractionResult.face){var o=e.extractionResult.face.width*i,h=e.extractionResult.face.height*i,l=e.extractionResult.face.x-(i-1)*e.extractionResult.face.width/2,c=e.extractionResult.face.y-(i-1)*e.extractionResult.face.height/2;l<0&&(o+=l,l=0),c<0&&(h+=c,c=0),l+o>=e.width&&(o=e.width-l),c+h>=e.height&&(h=e.height-c),r.width=o,r.height=h,r.getContext("2d").drawImage(n,l,c,o,h,0,0,r.width,r.height)}else r.width=e.width,r.height=e.height,r.getContext("2d").drawImage(n,0,0,r.width,r.height);var d=document.createElement("img");return d.src=r.toDataURL(s,a),d},handleExtractorMessage:function(e){if(null!=this.worker){this.fpseframes++;var t=this.faceAvailable;if(this.queuedCommands--,"ready"==e.data.cmd)this.queuedCommands++,this.wasmReady=!0,this.CheckDependencies(this);else if("detect"==e.data.cmd){this.lastDetectResult=e.data,this.faceAvailable=!1;var i=this.lastDetectResult;if(i.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.Ok){if(i.face){var s=this.fromCameraToScreenDetection(this,i.face);this.drawer.faceInsideCircle(s)&&(this.faceAvailable=!0,this.faceDataRect=s)}if(i.leftEye){s=this.fromCameraToScreenDetection(this,{x:i.leftEye.x,y:i.leftEye.y,width:1,height:1});this.privateEyesYLevel=s.y,this.leftEyeData=s}if(i.rightEye){s=this.fromCameraToScreenDetection(this,{x:i.rightEye.x,y:i.rightEye.y,width:1,height:1});this.rightEyeData=s}}this.faceTooFar=i.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.FaceTooFar,"UCWaitingEyeDetection"==this.state&&this.faceAvailable&&null==this.clockEyeDetectionDetected&&(this.clockEyeDetectionDetected=performance.now())}else if("extractNextSmart"==e.data.cmd){var a=e.data;if(this.faceTooFar=e.data.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.FaceTooFar,this.faceAvailable=!1,a.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.Ok){this.lastExtractionResult=e.data;s=this.fromCameraToScreenDetection(this,this.lastExtractionResult.face);this.drawer.faceInsideCircle(s)&&(this.faceAvailable=!0,this.faceDataRect=s)}if(a.leftEye){s=this.fromCameraToScreenDetection(this,{x:a.leftEye.x,y:a.leftEye.y,width:1,height:1});this.privateEyesYLevel=s.y,this.leftEyeData=s}if(a.rightEye){s=this.fromCameraToScreenDetection(this,{x:a.rightEye.x,y:a.rightEye.y,width:1,height:1});this.privateEyesYLevel=s.y,this.rightEyeData=s}"UCExtracting"==this.state&&(this.privateLastImage.extractionResult=a,a.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.Ok&&1==this.faceAvailable&&(this.privateImages.length<5?this.privateImages.push(this.privateLastImage):this.betterSustitution(this,this.privateImages,this.privateLastImage)))}else if("evaluateLiveness"==e.data.cmd)e.data.livenessDiagnostic==FPhi.Selphi.LivenessDiagnostic.LivenessDetected?this.graph.sendMessage("AuthenticationFinished"):(this.livenessActualRetrain+=e.data.penalty,this.livenessActualRetrain>=3?(this.livenessDiagnostic=e.data.livenessDiagnostic,this.graph.sendMessage("Errors")):this.clockLiveness3_finish=this.actualTime);else if("livenessTimerReset"==e.data.cmd);else if("livenessTimerSetValues"==e.data.cmd);else if("livenessTimerAdd"==e.data.cmd)1==e.data.status&&this.privateLivenessImages.push(this.privateLivenessImageTemp),1==e.data.isFull&&(this.privateLivenessTimerDiagnostic=e.data.livenessTimerDiagnostic,this.graph.sendMessage("LivenessTimerFull"));else if("nextLivenessMoveSequence"==e.data.cmd)this.livenessMoveDirection=e.data.direction,-1!=this.forceMoveDirection&&(this.livenessMoveDirection=this.forceMoveDirection);else if("nextLivenessMoveStabilization"==e.data.cmd){a=e.data;if(this.livenessMoveLastStabilizedStatus=a.faceStabilized,this.faceTooFar=3==a.faceStabilized,this.faceAvailable=!1,a.sampleDiagnostic==FPhi.Selphi.SampleDiagnostic.Ok&&(this.lastExtractionResult=e.data),a.face){s=this.fromCameraToScreenDetection(this,a.face);this.drawer.faceInsideCircle(s)&&(this.faceAvailable=!0,this.faceDataRect=s)}if(a.leftEye){s=this.fromCameraToScreenDetection(this,{x:a.leftEye.x,y:a.leftEye.y,width:1,height:1});this.privateEyesYLevel=s.y,this.leftEyeData=s}if(a.rightEye){s=this.fromCameraToScreenDetection(this,{x:a.rightEye.x,y:a.rightEye.y,width:1,height:1});this.privateEyesYLevel=s.y,this.rightEyeData=s}if(this.privateLastImage.extractionResult=a,1!=a.faceStabilized&&17!=a.faceStabilized||(this.livenessMoveStabilizedStatusHistory.push(a.faceStabilized),this.graph.sendMessage("FaceStabilized")),4==a.faceStabilized&&(this.livenessMoveGlassesFail++,this.livenessMoveFailReason=0,this.livenessMoveStabilizedStatusHistory.push(a.faceStabilized),this.graph.sendMessage("GlassesFound//"+this.livenessMoveGlassesFail)),null!=a.faceStabilized){var n=new CustomEvent("FPhi.UserControl.Stabilizing.event",{detail:a.faceStabilized});this.divContainer.dispatchEvent(n)}}else if("nextLivenessMoveImage"==e.data.cmd){this.livenessCalculating=!1;a=e.data;this.privateImages[this.livenessMoveNextIndex].extractionResult=a,this.privateLivenessImages[this.livenessMoveNextIndex]=null,this.livenessMoveNextIndex++}else if("evaluateLivenessMove"==e.data.cmd){this.livenessCalculating=!1;a=e.data;this.lastExtractionResult=e.data,this.livenessMoveHistory.push(a.livenessDiagnostic),a.livenessDiagnostic==FPhi.Selphi.LivenessDiagnostic.LivenessDetected?(this.livenessMoveActualSuccessfulAttempts++,this.livenessMoveLastAttempSuccessful=!0,this.graph.sendMessage("LivenessMoveRetry//"+this.livenessMoveActualSuccessfulAttempts+","+this.livenessMoveActualFailedAttempts)):(this.livenessMoveFailReason=1,this.livenessDiagnostic=a.livenessDiagnostic,this.livenessMoveActualFailedAttempts++,this.livenessMoveLastAttempSuccessful=!1,this.graph.sendMessage("LivenessMoveRetry//"+this.livenessMoveActualSuccessfulAttempts+","+this.livenessMoveActualFailedAttempts)),console.log("livenessMoveFailReason="+this.livenessMoveFailReason)}this.faceTooFar&&(this.faceAvailable=!1),1==t&&0==this.faceAvailable?this.clockWarningIn=this.actualTime:0==t&&1==this.faceAvailable?this.clockWarningOut=this.actualTime:this.faceAvailable&&this.actualTime-this.clockWarningOut>1e3*this.warningOutTime?this.faceAvailableDelayed=this.faceAvailable:!this.faceAvailable&&this.actualTime-this.clockWarningIn>1e3*this.warningInTime&&(this.faceAvailableDelayed=this.faceAvailable)}},startVideos:function(e){if(null!=e.elements)for(var t=0;t<e.elements.length;t++)if("video"==e.elements[t].type){var i=document.createElement("video");i.hidden=!0,i.playsinline=!0,i.loop=!1,i.muted=!0,i.autoplay=!0,i.controls=!0,i.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId(e.resourceParent,e.elements[t].id,e.drawer.landscape,"value")),i.addEventListener("ended",e.videoplayerEnded.bind(e),!1),i.setAttribute("playsinline",""),i.setAttribute("webkit-playsinline",""),i.play(),e.elements[t].videoPlayer=i}},canvasOnMove:function(e){if(void 0!=this.elements)for(var t=this.elements.length-1;t>=0;t--)if(void 0!=this.elements[t].layout&&e.offsetX>=this.elements[t].layout.x&&e.offsetX<this.elements[t].layout.x+this.elements[t].layout.width&&e.offsetY>=this.elements[t].layout.y&&e.offsetY<this.elements[t].layout.y+this.elements[t].layout.height){if(this.mode==FPhi.Selphi.Mode.Authenticate&&this.livenessMode!=FPhi.Selphi.LivenessMode.Blink&&"button_info"==this.elements[t].id)break;this.drawer.onMouseMove(e.target,this.elements[t].layout,this.resourceParent,this.elements[t].id,this.elements[t].type);break}},canvasOnClick:function(e){if("UCErrors"==this.state){e.offsetX;var t,i=e.offsetY,s=this.canvasHeight-this.buttonHeight;if(console.log("canvasOnClick",this.canvasHeight,s,i),i>s)-1==this.livenessDiagnostic?(t=new CustomEvent("FPhi.UserControl.TimeoutErrorButtonClick.event"),this.divContainer.dispatchEvent(t)):(t=new CustomEvent("FPhi.UserControl.LivenessErrorButtonClick.event"),this.divContainer.dispatchEvent(t))}else{if(void 0==this.elements)return;let t=null;for(var a=this.elements.length-1;a>=0;a--)if(null!=this.elements[a].layout&&e.offsetX>=this.elements[a].layout.x&&e.offsetX<this.elements[a].layout.x+this.elements[a].layout.width&&e.offsetY>=this.elements[a].layout.y&&e.offsetY<this.elements[a].layout.y+this.elements[a].layout.height){t=this.elements[a].id;var n="Click//"+this.elements[a].id;this.graph.sendMessage(n);break}if(null!=this.onTrackStatus&&this.divContainer){var r=new CustomEvent("FPhi.UserControl.TrackStatus.event",{detail:{code:FPhi.Selphi.TrackStatus.Tap,timeStamp:this.secondsWidget,data:t}});this.divContainer.dispatchEvent(r)}}},initCamera:function(e,t,i){var s=this.canvas;if(!this.video){var a=document.createElement("video");a.id="live",a.setAttribute("playsinline",""),a.setAttribute("webkit-playsinline",""),a.setAttribute("autoplay",""),a.setAttribute("muted",""),a.style.display="none",e.insertBefore(a,e.firstChild),this.video=a}s.imageSmoothingEnabled=!0;var n=s.clientWidth,r=s.clientHeight;this.circleX=n/2,this.circleY=.38*r,this.circleRadius=.31*r,s&&(s.style.display="none",s.onclick=this.canvasOnClick.bind(this),s.onmousemove=this.canvasOnMove.bind(this),this.privateCanvas=document.createElement("canvas"),0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=t,this.privateCanvas.height=i):(this.privateCanvas.width=i,this.privateCanvas.height=t))},userMedia:function(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},setVideoInput:function(e){e.canvas&&e.playDevice(e)},playDevice:function(e){var t,i=e.video,s=e.canvas.getContext("2d",{alpha:!0}),a=null;"undefined"!=typeof facePhiUserControl&&null!==facePhiUserControl.config.videoSelectId&&(a=facePhiUserControl.config.videoSelectId),window.stream&&window.stream.getTracks().forEach(e=>{e.stop()}),t={video:{deviceId:a?{exact:a}:void 0,width:e.cameraWidth,height:e.cameraHeight,facingMode:e.cameraType==FPhi.Selphi.CameraType.Front?"user":"environment"},audio:!1};navigator.mediaDevices.getUserMedia(t).then(function(t){e.cameraStream=t,i.srcObject=t,i.onloadedmetadata=e.videoLoaded.bind(e),i.play()}).catch(function(t){console.log("Camera error"),console.log(t),e.draw(e,e.imageCamera,s);var i=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(i)})},handleRecorderDataAvailable:function(e){console.log("Selphi: MediaRecorder data available",e),e.data&&e.data.size>0&&this.recordedBlobs.push(e.data)},handleRecorderOnStop:function(e){console.log("Selphi: MediaRecorder stopped."),this.recorderFinish=!0},gotDevices:function(e){var t=0;for(let i=0;i!==e.length;++i)"videoinput"===e[i].kind&&t++;this.cameraList=new Array(t);var i=0;for(let t=0;t!==e.length;++t){var s=e[t];if("videoinput"===s.kind){var a=document.createElement("option");a.value=s.deviceId,a.text=s.label,this.cameraList[i]=a,i++}}var n=new CustomEvent("FPhi.UserControl.Cameras.event",{detail:{cameras:this.cameraList}});this.divContainer.dispatchEvent(n)},handleCameraError:function(e){console.log("Camera GetUserMedia error: ",e)},fromCameraToScreen:function(e,t){var i=e.cameraWidth,s=e.cameraHeight;1!=e.cameraRotation&&3!=e.cameraRotation||(i=e.cameraHeight,s=e.cameraWidth);var a=e.scaleRect({width:i,height:s},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),n=a.width/i,r=a.height/s,o={x:t.x*n,y:t.y*r,width:t.width*n,height:t.height*r},h=e.reflectedX(a.width,o.x+o.width);return o.x=h,o.x+=a.x,o.y+=a.y,o},fromCameraToScreenDetection:function(e,t){var i=e.cameraWidth,s=e.cameraHeight;1!=e.cameraRotation&&3!=e.cameraRotation||(i=e.cameraHeight,s=e.cameraWidth);var a=e.scaleRect({width:i,height:s},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),n=a.width/i,r=a.height/s,o={x:t.x*n,y:t.y*r,width:t.width*n,height:t.height*r},h=e.reflectedX(a.width,o.x+o.width);return o.x=h,o.x+=a.x,o.y+=a.y,o},scaleRect:function(e,t,i){var s=t.x+t.width/2,a=t.y+t.height/2,n=t.width/e.width,r=t.height/e.height,o=e.width*n,h=e.height*n;return void 0==i?h<t.height&&(o=e.width*r,h=e.height*r):h>=t.height&&(o=e.width*r,h=e.height*r),{x:s-o/2,y:a-h/2,width:o,height:h}},scaleRectByFactor(e,t,i){var s=e.x+.5*e.width,a=e.y+.5*e.height,n={x:0,y:0,width:0,height:0};n.width=e.width*=t,n.height=e.height*=i,n.x=e.x,n.y=e.y;var r=e.x+.5*e.width-s,o=e.y+.5*e.height-a;return n.x-=r,n.y-=o,n},getGraphicalScore:function(e){var t=100*e/90*(100*e/90)*.9+.1;return t>1&&(t=1),t},saveImageToCanvas:function(e,t){var i=e.privateCanvas.getContext("2d");switch(e.cameraRotation){case 0:i.drawImage(t,0,0,e.cameraWidth,e.cameraHeight);break;case 1:i.save(),i.translate(e.cameraHeight/2,e.cameraWidth/2),i.rotate(Math.PI/2*e.cameraRotation),i.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2),i.restore();break;case 2:i.save(),i.translate(e.cameraWidth/2,e.cameraHeight/2),i.rotate(Math.PI/2*e.cameraRotation),i.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2),i.restore();break;case 3:i.save(),i.translate(e.cameraHeight/2,e.cameraWidth/2),i.rotate(Math.PI/2*e.cameraRotation),i.drawImage(t,-e.cameraWidth/2,-e.cameraHeight/2),i.restore()}},getLayoutFromXML:function(e,t,i,s,a){let n="LEFT",r="TOP",o=i,h=!1;if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"width")){null==o&&(o={});var l=this.rm.getSetupFloat(e,t,this.drawer.landscape,"width");o.width=l<=1?l*s:l,h=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"height")){null==o&&(o={});var c=this.rm.getSetupFloat(e,t,this.drawer.landscape,"height");o.height=c<=1?c*a:c,h=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"xAnchor")&&(n=this.rm.getSetupAlign(e,t,this.drawer.landscape,"xAnchor")),this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"yAnchor")&&(r=this.rm.getSetupAlign(e,t,this.drawer.landscape,"yAnchor")),this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"x")){null==o&&(o={});var d=this.rm.getSetupFloat(e,t,this.drawer.landscape,"x");o.x=d<=1&&d>=-1?d*s:d,"CENTER"==n?o.x=s/2-o.width/2+o.x:"RIGHT"==n&&(o.x=s-o.width+o.x),h=!0}if(this.rm.isAttributeAvailable(e,t,this.drawer.landscape,"y")){null==o&&(o={});var m=this.rm.getSetupFloat(e,t,this.drawer.landscape,"y");o.y=m<=1&&m>=-1?m*a:m,"CENTER"==r?o.y=a/2-o.height/2+o.y:"BOTTOM"==r&&(o.y=a-o.height+o.y),h=!0}return o},draw:function(e){if(null!=this.drawer){var t=this.video,i=this.canvas.getContext("2d",{alpha:!0}),s=i.canvas.clientWidth,a=i.canvas.clientHeight;this.canvasWidth=s,this.canvasHeight=a,i.clearRect(0,0,s,a),this.fpsframes++,this.actualTimePrev=this.actualTime,this.actualTime=performance.now();var n=(this.actualTime-this.fpsTime)/1e3;n>1&&(this.fps=this.fpsframes/n,this.fpseframes>0?this.fpse=this.fpseframes/n:this.fpse=0,this.fpsTime=this.actualTime,this.fpsframes=0,this.fpseframes=0);var r="Normal";if(this.actualTime-this.widgetTime>500&&("UCWaitingFaceStart"!=this.state&&"UCExtracting"!=this.state||this.faceAvailableDelayed||(r="Warning"),"UCLivenessMoveStabilizing"==this.state&&1!=this.livenessMoveLastStabilizedStatus&&2!=this.livenessMoveLastStabilizedStatus&&17!=this.livenessMoveLastStabilizedStatus&&(r="Warning")),this.iterateAutomata(this,t,i),this.secondsWidget=(this.actualTime-this.widgetTime)/1e3,this.secondsState=(this.actualTime-this.stateTime)/1e3,void 0!=this.elements){var o={progress:0};if(o.faceDataRect=this.faceDataRect,o.leftEyeData=this.leftEyeData,o.rightEyeData=this.rightEyeData,o.state=this.state,o.livenessMoveLastStabilizedStatus=this.livenessMoveLastStabilizedStatus,"UCExtracting"==this.state?0!=this.extractionTime?o.progress=this.extractionTimePartial/(1e3*this.extractionTime):o.progress=0:"UCShowResults"==this.state?o.progress=this.getGraphicalScore(this.lastExtractionResult.templateScore):"UCLivenessMoveDetecting"==this.state?o.livenessMoveDirection=this.livenessMoveDirection:"UCWaitingFaceStart"==this.state||"UCWaitingFaceStartDecision"==this.state?o.progress=1:"UCErrors"==this.state&&(o.livenessDiagnostic=this.livenessDiagnostic),this.livenessMode==FPhi.Selphi.LivenessMode.Move&&(o.liveness_move_last_result=this.livenessMoveLastAttemptSuccessful,o.liveness_move_attempts=this.livenessMoveActualSuccessfulAttempts+this.livenessMoveActualFailedAttempts,o.livenessMoveFailReason=this.livenessMoveFailReason,"UCLivenessMoveProcessing"==this.state&&(this.privateLivenessImages.length-this.processingIndexBase==0?o.progress=0:o.progress=(this.livenessMoveNextIndex-this.processingIndexBase)/(this.privateLivenessImages.length-this.processingIndexBase)),"UCTutorialMove3"==this.state&&(o.livenessMoveDirection=1,null!=this.elements)))for(var h=0;h<this.elements.length;h++)if("video"==this.elements[h].type)if(isNaN(this.elements[h].videoPlayer.duration))o.videoProgress=1;else{let e=this.elements[h].videoPlayer.currentTime/(this.elements[h].videoPlayer.duration/1.5);e>1&&(e=1),o.videoProgress=e}for(h=0;h<this.elements.length;h++){if("button"!=this.elements[h].type&&"buttonImage"!=this.elements[h].type||0!=this.interactible)if(null!=(w=this.drawer.getLayout(this.resourceParent,this.elements[h].id,this.elements[h].type,this.secondsWidget,this.secondsState,r,o))&&(w=this.getLayoutFromXML(this.resourceParent,this.elements[h].id,w,s,a)),null!=w){this.elements[h].layout=w;var l=this.elements[h].mode,c=!1;if(null!=l){for(var d=l.split("|"),m=0;m<d.length;m++)if(d[m]==r){c=!0;break}}else c=!0;if(1==c){if("video"==this.elements[h].type)o.player=this.elements[h].videoPlayer;else if("camera"==this.elements[h].type)if(o.eyesYLevel=this.privateEyesYLevel,o.blindText="","UCLivenessDetectionStep1"==this.state){var v=this.actualTime-this.clockLiveness1;(v/=1e3*this.liveness1Time)>1&&(v=1),v=(v-1)*(v-1)*(v-1)+1,o.blind=.8*v}else if("UCLivenessDetectionStep2"==this.state)o.blind=.8,o.blindText=this.rm.translate("message_blink");else if("UCLivenessDetectionStep3"==this.state){v=0;(v=(v=this.actualTime-this.clockLiveness3)/(1e3*this.liveness3Time)*.2)>.2&&(v=.2),o.blind=.8+v}else if("UCWaitingEyeDetection"==this.state)if(null==this.clockEyeDetectionDetected){v=0;(g=this.actualTime-this.clockEyeDetection)<1e3?v=1:((v=(g-1e3)/(1e3*this.liveness1Time))<0?v=0:v>1&&(v=1),v=1-v),o.blind=v}else{var g;(v=(g=this.actualTime-this.clockEyeDetectionDetected)/(1e3*this.liveness3Time)*.2)<0?v=0:v>.2&&(v=.2),o.blind=1-v}else o.blind=0;"button_info"==this.elements[h].id&&this.mode==FPhi.Selphi.Mode.Authenticate&&this.livenessMode!=FPhi.Selphi.LivenessMode.Blink||this.drawer.draw(i,w,this.resourceParent,this.elements[h].id,this.elements[h].type,this.secondsWidget,this.secondsState,r,o)}}}}else if("UCErrors"==this.state){i.fillStyle="white",i.fillRect(0,0,s,a),text=this.livenessErrorString,fontHeight=15*this.fontSizeFactor;var u=this.rm.getSetupResourceId("facephi-widget-conf","",this.drawer.landscape,"font_warning_message");i.font=fontHeight+"px '"+u+"'",i.fillStyle="black";for(var p=text.split("\n"),f=0;f<p.length;f++){var C=i.measureText(p[f]),S=330*this.canvasSizeFactor+fontHeight*f;i.fillText(p[f],s/2-C.width/2,S)}var y=this.livenessErrorImage,w=this.scaleRect({width:y.width,height:y.height},{x:.03*s,y:.378*a,width:.94*s,height:.1*a},!0);i.drawImage(y,w.x,w.y,w.width,w.height),this.drawButton(this,i,{x:0,y:a-this.buttonHeight,width:s,height:this.buttonHeight},"Results","button_finish"),this.secondsState}if(this.debug&&null!=this.worker){var T=1;if(i.font="12px Verdana",i.fillStyle="gray",i.fillText("Version: "+this.extractorVersion,0,20*T),T++,i.fillText("State: "+this.state,0,20*T),T++,i.fillText("FPS: "+this.fps.toFixed(2),0,20*T),T++,i.fillText("FPS Extractor: "+this.fpse.toFixed(2),0,20*T),T++,i.fillText("Camera size: "+this.cameraWidth+"x"+this.cameraHeight+"px",0,20*T),T++,i.fillText("Canvas size: "+s+"x"+a+"px",0,20*T),T++,i.fillText("Camera rotation: "+this.cameraRotation,0,20*T),T++,i.fillText("WidgetTime: "+this.secondsWidget,0,20*T),T++,i.fillText("StateTime: "+this.secondsState,0,20*T),T++,i.fillText("Mode: "+r,0,20*T),T++,i.fillText("Images: "+this.privateImages.length,0,20*T),T++,i.fillText("Face available: "+this.faceAvailable,0,20*T),T++,i.fillText("EyesYLevel: "+Math.round(this.privateEyesYLevel),0,20*T),T++,this.livenessMode==FPhi.Selphi.LivenessMode.Move){var x=this.privateLivenessImages.length;for(h=0;h<30;h++)h<this.livenessMoveNextIndex?i.fillStyle="green":i.fillStyle=h<x?"red":"gray",i.fillRect(10*h+5,20*T+15,5,10)}var F=this.lastDetectResult;if(null!=F){if(void 0!==F.face){i.fillText("Face: ["+F.face.x+","+F.face.y+","+F.face.width+","+F.face.height+"]",0,20*T),T++,i.beginPath(),i.lineWidth="3",i.strokeStyle="red";var E=this.fromCameraToScreen(this,{x:F.face.x,y:F.face.y,width:F.face.width,height:F.face.height});i.rect(E.x,E.y,E.width,E.height),i.stroke()}if(void 0!==F.leftEye){i.beginPath(),i.lineWidth="6",i.strokeStyle="red";E=this.fromCameraToScreen(this,{x:F.leftEye.x,y:F.leftEye.y,width:1,height:1});i.rect(E.x,E.y,E.width,E.height),i.stroke()}if(void 0!==F.rightEye){i.beginPath(),i.lineWidth="6",i.strokeStyle="red";E=this.fromCameraToScreen(this,{x:F.rightEye.x,y:F.rightEye.y,width:1,height:1});i.rect(E.x,E.y,E.width,E.height),i.stroke()}}}null!=this.worker&&setTimeout(this.draw.bind(this),this.samplePeriod)}},reduceRect:function(e,t){var i=e.width*(1-t),s=e.height*(1-t);return e.x=e.x+(e.width-i)/2,e.y=e.y+(e.height-s)/2,e.width=i,e.height=s,e},drawStringMultiline:function(e,t,i,s,a,n,r){var o=i.split("\n");t.imageSmoothingEnabled=!1,r=Math.round(r*e.fontSizeFactor),t.font="normal "+r+"px '"+n+"'",t.fillStyle=a;for(var h=0;h<o.length;h++)dim=t.measureText(o[h]),t.fillText(o[h],e.canvasWidth/2-dim.width/2,s+h*(r+1))},setOffInterface:function(e,t,i){e.beginPath(),e.lineWidth="5",e.fillStyle="gray",e.fillRect(0,0,i,i),e.stroke()},adaptText:function(e,t,i,s){if(t.font=s,t.measureText(i).width>e){var a=s.indexOf("px"),n=s.substring(0,a);return s=--n+s.substring(a,s.length),t.font=s,this.adaptText(e,t,i,s)}return!0},reflectedX:function(e,t){return e-t},iterateAutomata:function(e,t,i){if(0!=e.cameraReady){if(0==e.wasmInitiated){e.wasmInitiated=!0;var s=e.privateCanvas.width;s>e.privateCanvas.height&&(s=e.privateCanvas.height),e.postMessage(e,{cmd:"init",extractionMode:e.mode,livenessMode:e.livenessMode,stabilizationStage:e.stabilizationStage,minIOD:.125*s,maxIOD:.27*s,cameraWidth:e.privateCanvas.width,cameraHeight:e.privateCanvas.height})}if("UCNothing"==e.state){var a=e.canvas;null!=a&&(a.style.display="inline-block");var n="SetMode//"+e.mode+","+e.livenessMode+",0,"+(e.tutorial?1:0);console.log(n),e.graph.sendMessage(n)}else if("UCTutorialRegister1"==e.state)e.evaluateScenarioTimeout(e);else if("UCTutorialRegister2"==e.state)e.evaluateScenarioTimeout(e);else if("UCWaitingFaceStart"==e.state)0==e.queuedCommands&&e.wasmReady&&(e.saveImageToCanvas(e,t),e.privateLastImage=e.getImageData(e.privateCanvas),e.postMessage(e,{cmd:"detect",data:e.privateLastImage.pixels.data,width:e.privateLastImage.width,height:e.privateLastImage.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e));else if("UCWaitingFaceStartDecision"==e.state)1==e.stabilizationStage?e.graph.sendMessage("Stabilize"):e.graph.sendMessage("Extract");else if("UCExtracting"==e.state)e.faceAvailableDelayed&&(e.extractionTimePartial+=e.actualTime-e.actualTimePrev),0==e.queuedCommands&&(e.actualTime-e.clockExtractionPure>e.detectionTimeout&&0==e.privateImages.length?(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout")):e.extractionTime>0&&(e.extractionTimePartial<1e3*e.extractionTime||0==e.privateImages.length)?e.actualTime-e.clockExtractionPure>e.extractionTimeout?(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout")):(e.saveImageToCanvas(e,t),e.privateLastImage=e.getImageData(e.privateCanvas),e.postMessage(e,{cmd:"extractNextSmart",data:e.privateLastImage.pixels.data,width:e.privateLastImage.width,height:e.privateLastImage.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp})):e.mode==FPhi.Selphi.Mode.Register?e.graph.sendMessage("RegistrationFinished"):e.livenessMode==FPhi.Selphi.LivenessMode.Blink?e.graph.sendMessage("SetLivenessBlink"):e.livenessMode==FPhi.Selphi.LivenessMode.Move?e.graph.sendMessage("SetLivenessMove"):e.graph.sendMessage("AuthenticationFinished"));else if("UCShowResults"==e.state)e.evaluateScenarioTimeout(e);else if("UCWaitingEyeDetection"==e.state){if(performance.now()-e.clockEyeDetection>e.detectionTimeout)return e.livenessDiagnostic=-1,void e.graph.sendMessage("Timeout");var r=performance.now()-e.clockEyeDetection;if(r>1e3&&null==e.clockEyeDetectionDetected&&r<1e3+1e3*e.liveness1Time)return;if(r>1e3+1e3*e.liveness1Time&&null!=e.clockEyeDetectionDetected)return void e.graph.sendMessage("ResetLivenessBlink");null!=e.clockEyeDetectionDetected&&performance.now()-e.clockEyeDetectionDetected>1e3*e.liveness3Time&&e.graph.sendMessage("Timer"),null==e.clockEyeDetectionDetected&&0==e.queuedCommands&&e.wasmReady&&(e.saveImageToCanvas(e,t),e.privateLastImage=e.getImageData(e.privateCanvas),e.postMessage(e,{cmd:"detect",data:e.privateLastImage.pixels.data,width:e.privateLastImage.width,height:e.privateLastImage.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e))}else if("UCLivenessDetectionStep1"==e.state)performance.now()-e.clockLiveness1>1e3*e.liveness1Time&&e.graph.sendMessage("Timer");else if("UCLivenessDetectionStep2"==e.state)0==e.queuedCommands&&e.wasmReady&&(e.saveImageToCanvas(e,t),e.privateLivenessImageTemp=e.getImageData(e.privateCanvas),e.postMessage(e,{cmd:"livenessTimerAdd",milliseconds:performance.now()-e.clockLiveness2}));else if("UCLivenessDetectionStep3"==e.state)null!=e.clockLiveness3_finish&&performance.now()-e.clockLiveness3_finish>1e3*e.liveness3Time&&e.graph.sendMessage("EyeDetectionNeeded");else if("UCLivenessMoveStabilizing"==e.state)if(e.secondsState>=10){e.livenessDiagnostic=-1,e.livenessMoveStabilizedStatusHistory.push(-1),e.graph.sendMessage("Timeout");var o=new CustomEvent("FPhi.UserControl.Stabilizing.event",{detail:-1});this.divContainer.dispatchEvent(o)}else 0==e.queuedCommands&&e.wasmReady&&(e.saveImageToCanvas(e,t),e.privateLastImage=e.getImageData(e.privateCanvas),e.postMessage(e,{cmd:"nextLivenessMoveStabilization",data:e.privateLastImage.pixels.data,width:e.privateLastImage.width,height:e.privateLastImage.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp}));else if("UCLivenessMoveDetecting"==e.state){if(e.secondsState>.5){let i=Math.round(1e3*e.secondsState);if(e.livenessMoveTimer.Add(i)){e.saveImageToCanvas(e,t);let i=e.getImageData(e.privateCanvas);e.privateLivenessImages.push(i),this.privateImages.push(i),this.privateLivenessResults.push(this.secondsWidget),0==e.queuedCommands&&e.wasmReady&&!e.livenessCalculating&&e.livenessMoveNextIndex<e.privateLivenessImages.length&&e.privateLivenessImages.length>0&&(e.livenessCalculating=!0,i=e.privateLivenessImages[e.livenessMoveNextIndex],e.debug&&console.log({image:e.getImgTag(i,!1,1,"image/jpeg",e.imageQuality)}),e.postMessage(e,{cmd:"nextLivenessMoveImage",data:i.pixels.data,width:i.width,height:i.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp}))}e.livenessMoveTimer.IsFull()&&e.graph.sendMessage("LivenessTimerFull")}}else"UCLivenessMoveProcessing"==e.state?0==e.queuedCommands&&e.wasmReady&&(!e.livenessCalculating&&e.livenessMoveNextIndex>=e.privateLivenessImages.length?(e.livenessCalculating=!0,e.postMessage(e,{cmd:"evaluateLivenessMove",timer:e.livenessMoveTimer})):!e.livenessCalculating&&e.livenessMoveNextIndex<e.privateLivenessImages.length&&e.privateLivenessImages.length>0&&(e.livenessCalculating=!0,imData=e.privateLivenessImages[e.livenessMoveNextIndex],e.debug&&console.log({image:e.getImgTag(imData,!1,1,"image/jpeg",e.imageQuality)}),e.postMessage(e,{cmd:"nextLivenessMoveImage",data:imData.pixels.data,width:imData.width,height:imData.height,format:FPhi.Selphi.ImageFormat.RGBA_32bpp}))):"UCLivenessMoveInfo"==e.state?e.secondsState>e.livenessMoveInfoTime&&(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout")):"UCWaitRecording"==e.state&&(e.cm.getVideoRecord()?e.recorderFinish&&e.graph.sendMessage("Finish"):e.graph.sendMessage("Finish"));if(e.cm.getVideoRecord()&&e.recorder.isReady()){e.privateRecordCanvasContext.drawImage(t,0,0,e.privateRecordCanvas.width,e.privateRecordCanvas.height);var h=e.privateRecordCanvasContext.getImageData(0,0,e.privateRecordCanvas.width,e.privateRecordCanvas.height);e.recorder.addFrame(h)}}},evaluateScenarioTimeout:function(e){e.sceneTimeout>0&&performance.now()-e.clockNewScenario>1e3*e.sceneTimeout&&(e.livenessDiagnostic=-1,e.graph.sendMessage("Timeout"))},getVideoSources:function(e){if(navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e,t){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}):MediaStreamTrack.getSources(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e,t){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}),null==selectedSource){FacePhiDisplayErrorImage(facePhiUserControl.config.width,folderPath+commonPath+"/Images/errorNoCamsEs.png",folderPath+commonPath+"/Images/errorNoCamsEn.png","FacePhiWidgetWeb",e.divContainer,0,"","",0,Verdana,"Bold","black",0);var t=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(t)}},getScriptPath:function(e){var t,i=document.getElementsByTagName("script"),s=0;for(t=0;t<i.length;t++)i[t].src.indexOf(e)>-1&&(s=t);return i[s].src.split("/").slice(0,-1).join("/")+"/"},distAlgSustitution:function(e,t,i){for(var s,a=Number.MAX_VALUE,n=1;n<t.length;n++){var r=t.slice();r[n]=i,r.sort(function(e,t){return e.time-t.time});var o=e.desviacionTipica(e,r);o<a&&(a=o,s=r)}return s},betterSustitution:function(e,t,i){for(var s=Number.MAX_VALUE,a=0,n=0;n<t.length;n++){var r=t[n].extractionResult.facialScore;r<s&&(s=r,a=n)}i.extractionResult.facialScore>s&&(t[a]=i)},sortImagesByFacialScore:function(e,t){t.sort(function(e,t){return afs=void 0!=e.extractionResult?e.extractionResult.facialScore:0,bfs=void 0!=t.extractionResult?t.extractionResult.facialScore:0,bfs-afs})},desviacionTipica:function(e,t){for(var i=e.media(e,t),s=0,a=1;a<t.length;a++){var n=t[a].time-t[a-1].time;s+=(n-i)*(n-i)}return s=Math.sqrt(s/(t.length-2))},media:function(e,t){for(var i=0,s=1;s<t.length;s++){i+=t[s].time-t[s-1].time}return i/(t.length-1)},OnResourceManagerLoaded:function(e){this.rm=new FPhi.ResourceManager(this.baseURL,this.language,this,this.OnResourceManagerStatus,this.dpiList,window.devicePixelRatio,this.canvasSizeFactor)},OnResourceManagerStatus:function(e,t){t&&(e.rmReady=!0,e.CheckDependencies(e))},OnGraphLoaded:function(e){this.graph=new FPhi.Graph(this.path+this.graphPath,this.OnGraphReady.bind(this),this.OnGraphNewState.bind(this))},OnGraphReady:function(e){this.graphReady=!0,this.CheckDependencies(this)},OnDrawerLoaded:function(e){this.drawer=new FPhi.Drawer(this.mode,this.livenessMode,this.stabilizationStage,this.canvasSizeFactor,this.fontSizeFactor),this.CheckDependencies(this)},CheckDependencies:function(e){if(1==e.rmReady&&void 0!==e.drawer&&1!=e.resourcesCached&&(e.drawer.rm=e.rm,e.drawer.cacheResources(),e.resourcesCached=!0),1==e.rmReady&&void 0!==e.drawer&&1==e.graphReady&&1==e.wasmReady&&1==e.cameraReady&&"UCNothing"!=e.graph.state){var t=e.canvas;null!=t&&(t.style.display="none"),e.video.style.display="inline-block",e.drawer.setCanvasSize(t.clientWidth,t.clientHeight),e.graph.setInitialState("UCNothing");var i=new CustomEvent("FPhi.UserControl.ModuleLoaded.event",{detail:{cameraWidth:e.cameraWidth,cameraHeight:e.cameraHeight,instance:e}});e.divContainer.dispatchEvent(i),setTimeout(e.draw.bind(e),e.samplePeriod),e.cameraContainer.removeChild(e.gifWait)}},videoLoaded:function(e){this.cameraWidth=e.target.videoWidth,this.cameraHeight=e.target.videoHeight,0==this.cameraRotation||2==this.cameraRotation?(this.privateCanvas.width=this.cameraWidth,this.privateCanvas.height=this.cameraHeight):(this.privateCanvas.width=this.cameraHeight,this.privateCanvas.height=this.cameraWidth),this.cameraReady=!0,this.debug&&console.log("Timing-Camera-ready: "+performance.now());this.video,this.canvas.getContext("2d",{alpha:!0});if(this.cm.getVideoRecord()){switch(console.log("Selphi: Video recording enabled..."),this.videoRecordWidth=this.cameraWidth*this.cm.getVideoRecordScale(),this.videoRecordHeight=this.cameraHeight*this.cm.getVideoRecordScale(),this.cm.getVideoRecordType()){case FPhi.Selphi.RecorderType.Gif:this.recorder=new FPhi.Selphi.GifRecorder(this.cameraWidth*this.cm.getVideoRecordScale(),this.cameraHeight*this.cm.getVideoRecordScale(),this.cm.getVideoRecordRate(),this.path);break;case FPhi.Selphi.RecorderType.Remote:this.recorder=new FPhi.Selphi.FacephiRemoteRecorder(this.cameraWidth*this.cm.getVideoRecordScale(),this.cameraHeight*this.cm.getVideoRecordScale(),this.cm.getVideoRecordRate(),this.path)}this.privateRecordCanvas=document.createElement("canvas"),this.privateRecordCanvas.width=this.videoRecordWidth,this.privateRecordCanvas.height=this.videoRecordHeight,this.privateRecordCanvasContext=this.privateRecordCanvas.getContext("2d")}this.CheckDependencies(this)},videoFrame:function(e){this.canvasVideoPlayer.getContext("2d").drawImage(e.target,0,0)},videoplayerEnded:function(e){"UCWizardCompleted"==this.state?this.graph.sendMessage("VideoFinished"):e.target.play()}},void 0===FPhi.Timer){class Timer{constructor(){this.desiredFPS=0,this.desiredFrameTime=0,this.tolerance=.5,this.desiredRelativeTolerance=0,this.maxSize=0,this.k=0,this.timeCodes=[],this.desiredIndAll=0,this.timeLapse=0,this.initialOffset=0,this.currentOffset=0}SetValues(e,t,i){return!(e<=0)&&(!(t<=0)&&(!(i<0)&&(this.desiredFPS=t,this.desiredFrameTime=1/t*1e3,this.desiredRelativeTolerance=this.desiredFrameTime*this.tolerance,this.maxSize=Math.ceil(this.desiredFPS*e/1e3),this.timeCodes=[],this.timeLapse=e,this.initialOffset=i,!0)))}GetTimeLapse(){return this.timeLapse}GetFps(){return this.desiredFPS}Reset(){this.timeCodes=[],this.k=0,this.desiredIndAll=-1}Add(e){if(e<0)return!1;if(this.k>=this.maxSize)return!1;if(0==this.currentOffset&&(this.currentOffset=e),Math.abs(e-this.currentOffset)<this.initialOffset)return!1;if(0==this.k)this.timeCodes.push(e),this.k++;else{var t=Math.round(e/this.desiredFrameTime);t<=this.desiredIndAll&&t++;var i=e-this.timeCodes[this.k-1]>this.desiredRelativeTolerance,s=t*this.desiredFrameTime-e<this.desiredRelativeTolerance;if(!i||!s)return!1;this.timeCodes.push(e),this.k++,this.desiredIndAll=t}return!0}IsFull(){return this.k>=this.maxSize}GetTimeCodes(){return this.timeCodes}}FPhi.Timer=Timer}if(void 0===FPhi.Selphi.ConfigurationManager){class ConfigurationManager{constructor(){this.container=null,this.language="es",this.dpiList=[163,326,489],this.cameraWidth=1280,this.cameraHeight=720,this.cameraType=FPhi.Selphi.CameraType.Front,this.cameraRotation=0,this.resourcesPath=FPhi.Selphi.Widget.prototype.getScriptPath("FPhi.Widget.wasm.js")+"FPhi.Widget.Resources/",this.onExtractionFinish=null,this.onUserCancel=null,this.onExceptionCaptured=null,this.onExtractionTimeout=null,this.onModuleLoaded=null,this.onLivenessError=null,this.onLivenessErrorButtonClick=null,this.onTimeoutErrorButtonClick=null,this.onStabilizing=null,this.onTrackStatus=null,this.mode=FPhi.Selphi.Mode.Authenticate,this.livenessMode=FPhi.Selphi.LivenessMode.None,this.tutorial=!1,this.stabilizationStage=!1,this.livenessPrecision=2,this.livenessMoveInitialError=0,this.livenessMoveInfoTime=3,this.interactible=!0,this.registerTime=7,this.authenticateTime=1,this.graphPath="graph.xml",this.imageFormat="image/jpeg",this.imageQuality=.92,this.logImages=!1,this.cropFactor=1,this.cropImage=!0,this.templateFormat=FPhi.Selphi.TemplateFormat.Base64,this.videoRecord=!1,this.videoRecordRate=10,this.videoRecordScale=1,this.videoRecordType=FPhi.Selphi.RecorderType.Gif}setContainer(e){this.container=e}getContainer(){return this.container}setLanguage(e){this.language=e}getLanguage(){return this.language}setDpiList(e){this.dpiList=e}getDpiList(){return this.dpiList}setCameraWidth(e){this.cameraWidth=e}getCameraWidth(){return this.cameraWidth}setCameraHeight(e){this.cameraHeight=e}getCameraHeight(){return this.cameraHeight}setCameraType(e){this.cameraType=e}getCameraType(){return this.cameraType}setCameraRotation(e){this.cameraRotation=e}getCameraRotation(){return this.cameraRotation}setResourcesPath(e){this.resourcesPath=e}getResourcesPath(){return this.resourcesPath}setOnExtractionFinish(e){this.onExtractionFinish=e}getOnExtractionFinish(){return this.onExtractionFinish}setOnUserCancel(e){this.onUserCancel=e}getOnUserCancel(){return this.onUserCancel}setOnExceptionCaptured(e){this.onExceptionCaptured=e}getOnExceptionCaptured(){return this.onExceptionCaptured}setOnExtractionTimeout(e){this.onExtractionTimeout=e}getOnExtractionTimeout(){return this.onExtractionTimeout}setOnModuleLoaded(e){this.onModuleLoaded=e}getOnModuleLoaded(){return this.onModuleLoaded}setOnLivenessError(e){this.onLivenessError=e}getOnLivenessError(){return this.onLivenessError}setOnLivenessErrorButtonClick(e){this.onLivenessErrorButtonClick=e}getOnLivenessErrorButtonClick(){return this.onLivenessErrorButtonClick}setOnTimeoutErrorButtonClick(e){this.onTimeoutErrorButtonClick=e}getOnTimeoutErrorButtonClick(){return this.onTimeoutErrorButtonClick}setOnStabilizing(e){this.onStabilizing=e}getOnStabilizing(){return this.onStabilizing}setOnTrackStatus(e){this.onTrackStatus=e}getOnTrackStatus(){return this.onTrackStatus}setMode(e){this.mode=e}getMode(){return this.mode}setLivenessMode(e){this.livenessMode=e}getLivenessMode(){return this.livenessMode}setTutorial(e){this.tutorial=e}getTutorial(){return this.tutorial}setStabilizationStage(e){this.stabilizationStage=e}getStabilizationStage(){return this.stabilizationStage}setLivenessPrecision(e){this.livenessPrecision=e}getLivenessPrecision(){return this.livenessPrecision}setLivenessMoveInitialError(e){this.livenessMoveInitialError=e}getLivenessMoveInitialError(){return this.livenessMoveInitialError}setLivenessMoveInfoTime(e){this.livenessMoveInfoTime=e}getLivenessMoveInfoTime(){return this.livenessMoveInfoTime}setInteractible(e){this.interactible=e}getInteractible(){return this.interactible}setRegisterTime(e){this.registerTime=e}getRegisterTime(){return this.registerTime}setAuthenticateTime(e){this.authenticateTime=e}getAuthenticateTime(){return this.authenticateTime}setGraphPath(e){this.graphPath=e}getGraphPath(){return this.graphPath}setImageFormat(e){this.imageFormat=e}getImageFormat(){return this.imageFormat}setImageQuality(e){this.imageQuality=e}getImageQuality(){return this.imageQuality}setLogImages(e){this.logImages=e}getLogImages(){return this.logImages}setCropFactor(e){this.cropFactor=e}getCropFactor(){return this.cropFactor}setCropImage(e){this.cropImage=e}getCropImage(){return this.cropImage}setTemplateFormat(e){this.templateFormat=e}getTemplateFormat(){return this.templateFormat}setVideoRecord(e){this.videoRecord=e}getVideoRecord(){return this.videoRecord}setVideoRecordRate(e){this.videoRecordRate=e}getVideoRecordRate(){return this.videoRecordRate}setVideoRecordScale(e){this.videoRecordScale=e}getVideoRecordScale(){return this.videoRecordScale}setVideoRecordType(e){this.videoRecordType=e}getVideoRecordType(){return this.videoRecordType}}FPhi.Selphi.ConfigurationManager=ConfigurationManager;class BaseRecorder{constructor(e,t,i,s){this.width=e,this.height=t,this.rate=i,this.rateInv=1/this.rate,this.lastFrame=performance.now()}frameReady(){let e=performance.now();return(e-this.lastFrame)/1e3>this.rateInv&&(this.lastFrame=e,!0)}addFrame(e){throw new Error("Method addFrame must be implemented.")}generateVideo(){throw new Error("Method generateVideo must be implemented.")}isReady(){throw new Error("Method isReady must be implemented")}}class GifRecorder extends BaseRecorder{constructor(e,t,i,s){super(e,t,i,s),this.ag=new Animated_GIF,this.ag.setSize(e,t),this.ag.setDelay(this.rateInv),this.processing=!1}addFrame(e){this.frameReady()&&(console.log("Recorder: AddFrame"),this.ag.addFrameImageData(e))}generateVideo(){this.processing=!0;let e=this;return new Promise(function(t,i){console.log("generating movie inside"),e.ag.getBase64GIF(function(e){console.log("movie generated"),t(e)})})}isReady(){return!this.processing}}FPhi.Selphi.GifRecorder=GifRecorder;class FacephiRemoteRecorder extends BaseRecorder{constructor(e,t,i,s){super(e,t,i),this.processing=!1,this.ready=!1,console.log(s),this.worker=new Worker(s+"FPhi.RemoteRecorder.worker.js"),this.worker.onmessage=this.onMessage.bind(this),this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t,this.promise=null,this.resolve=null,this.reject=null}onMessage(e){if("ready"==e.data.cmd)this.ready=!0;else if("message"==e.data.cmd){let t=JSON.parse(e.data.data);"SAVED_FRAME"==t.type?this.ready=!0:(this.resolve(t.video),console.log("video generated: "+t.video))}}addFrame(e){if(!this.frameReady())return;console.log("Recorder: AddFrame"),this.canvas.getContext("2d").putImageData(e,0,0);let t=this.canvas.toDataURL("image/jpeg");this.worker.postMessage({cmd:"addFrame",data:t})}generateVideo(){this.processing=!0;let e=this;return this.promise=new Promise(function(t,i){e.resolve=t,e.reject=i,e.worker.postMessage({cmd:"generateVideo",fr:e.rate})}),this.promise}isReady(){return!this.processing&&!!this.ready}}FPhi.Selphi.FacephiRemoteRecorder=FacephiRemoteRecorder}